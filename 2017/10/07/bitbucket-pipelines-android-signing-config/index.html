<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="UTF-8" />
  <title>BitBucket Pipelines Android Signing Config | Olivier Patry</title>

  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Lato:300,300italic">
  <link rel="stylesheet" type="text/css" href="/assets/styles.css">
  <link rel="stylesheet" type="text/css" href="/assets/pygments/manni.css">
  <link rel="shortcut icon" href="/favicon.ico">

  <meta name=viewport content="width=device-width">

  <!-- Android Chrome 39+ theme color -->
  <meta name="theme-color" content="#3498db">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml">

</head>
<body>

<div class="site">
<header class="title">
  <h1 class="author">
  <a href="/" title="back to home">Olivier Patry</a>
  </h1>
</header>

<div class="content">
  <article>
    <header>
    <h1>BitBucket Pipelines Android Signing Config</h1>
    </header>

    <section>
    <p>Building Android release APK can be a bit tedious when it comes to signing it.
Storing (and sharing to a restricted audience) the signing configuration, should
be done carefully especially on Open Source projects.</p>

<p>Using Git submodule, we can isolate sensitive information from public and only
allow access to Continuous Integration users and repository administrators.</p>

<p>First create a new repository (<code>secret</code>) with restricted access.</p>

<p>Add sensitive information in it.</p>

<p><code>playstore.properties</code>:</p>

<div class="code-container">
<div class="langspec">Properties</div>
<pre class="highlight"><code class="language-properties"><span class="na">storeFile</span><span class="o">=</span><span class="s">myapp.keystore</span>
<span class="na">keyAlias</span><span class="o">=</span><span class="s">myapp_android</span>
<span class="na">storePassword</span><span class="o">=</span><span class="s">SENSITIVE_PASSWORD</span>
<span class="na">keyPassword</span><span class="o">=</span><span class="s">SENSITIVE_PASSWORD2</span></code></pre>
</div>
<p>Add your <code>myapp.keystore</code> near the <code>playstore.properties</code> file.</p>

<p>Add it to your application as a submodule.</p>

<div class="code-container">
<div class="langspec">Bash</div>
<pre class="highlight"><code class="language-bash">$ git submodule add &lt;url&gt; build/secret</code></pre>
</div>
<p>Configure the application signing configuration in Gradle:</p>

<p><code>app/build.gradle</code></p>

<div class="code-container">
<div class="langspec">Groovy</div>
<pre class="highlight"><code class="language-groovy"><span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'com.android.application'</span>

<span class="kt">def</span> <span class="n">signingPropertiesFile</span> <span class="o">=</span> <span class="n">file</span><span class="o">(</span><span class="s1">'../../build/secret/playstore.properties'</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">keystoreProperties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">()</span>
<span class="k">if</span> <span class="o">(</span><span class="n">signingPropertiesFile</span> <span class="o">&amp;&amp;</span> <span class="n">signingPropertiesFile</span><span class="o">.</span><span class="na">isFile</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">keystoreProperties</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">signingPropertiesFile</span><span class="o">))</span>
<span class="o">}</span>

<span class="n">android</span> <span class="o">{</span>

    <span class="n">signingConfigs</span> <span class="o">{</span>
        <span class="n">debug</span> <span class="o">{</span>
            <span class="c1">// "public" development keystore file shared between developers</span>
            <span class="n">storeFile</span> <span class="nf">file</span><span class="o">(</span><span class="s1">'../myapp_dev.keystore'</span><span class="o">)</span>
            <span class="n">storePassword</span> <span class="s1">'devapp'</span>
            <span class="n">keyAlias</span> <span class="s1">'myapp_android_dev'</span>
            <span class="n">keyPassword</span> <span class="s1">'devapp'</span>
        <span class="o">}</span>
        <span class="n">release</span> <span class="o">{</span>
            <span class="n">storeFile</span> <span class="o">=</span> <span class="n">keystoreProperties</span><span class="o">[</span><span class="s1">'storeFile'</span><span class="o">]</span>
                  <span class="o">?</span> <span class="n">file</span><span class="o">(</span><span class="s2">"../../build/secret/${keystoreProperties['storeFile']}"</span><span class="o">)</span> 
                  <span class="o">:</span> <span class="kc">null</span>
            <span class="n">storePassword</span> <span class="o">=</span> <span class="n">keystoreProperties</span><span class="o">[</span><span class="s1">'storePassword'</span><span class="o">]</span>
            <span class="n">keyAlias</span> <span class="o">=</span> <span class="n">keystoreProperties</span><span class="o">[</span><span class="s1">'keyAlias'</span><span class="o">]</span>
            <span class="n">keyPassword</span> <span class="o">=</span> <span class="n">keystoreProperties</span><span class="o">[</span><span class="s1">'keyPassword'</span><span class="o">]</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">buildTypes</span> <span class="o">{</span>
        <span class="n">debug</span> <span class="o">{</span>
            <span class="n">signingConfig</span> <span class="n">signingConfigs</span><span class="o">.</span><span class="na">debug</span>
        <span class="o">}</span>
        <span class="n">release</span> <span class="o">{</span>
            <span class="n">signingConfig</span> <span class="n">signingConfigs</span><span class="o">.</span><span class="na">release</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
<p>The tricky part is now to tell BitBucket how to initialize the secret submodule.
To do so, you’ll have to manually initialize the submodule in your pipeline file.</p>

<p>In your BitBucket’s application repository, go to <code>Settings &gt; Pipelines / Environment Variables</code>.
Add 2 new <em>secured</em> environment variables for user (<code>BITBUCKET_USER</code>) and password
 (<code>BITBUCKET_PASS</code>). Use values allowed to clone your <code>secret</code> repository.</p>

<p>Finally trigger the submodule initialization using these secret credentials:</p>

<p><code>bitbucket-pipelines.yml</code>:</p>

<div class="code-container">
<div class="langspec">Yaml</div>
<pre class="highlight"><code class="language-yaml"><span class="l l-Scalar l-Scalar-Plain">pipelines</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">branches</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">master</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">step</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">script</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">git config --file=.gitmodules submodule.build/secret.url https://$BITBUCKET_USER:$BITBUCKET_PASS@bitbucket.org/shht/secrets.git</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">git submodule sync</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">git submodule update --init build/secret</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./gradlew assembleRelease</span></code></pre>
</div>
<p><a href="https://community.atlassian.com/t5/Bitbucket-questions/Bitbucket-Pipelines-and-git-submodules/qaq-p/130479">Source</a>.</p>

    </section>


    <footer>
    <hr>

    <p id="navlinks" class="navinfos">
    <a class="prev" title="Automated web site deployment" href="/2014/04/11/automated-web-site-deployment/">&#9666;&nbsp;Automated web site deployment</a>
    <span>|</span>
    <a class="next" title="Android Studio Layout Preview Tools" href="/2017/10/28/android-studio-layout-preview-tools/">Android Studio Layout Preview Tools&nbsp;&#9656;</a>
    </p>
    </footer>

  </article>
</div>

</div> <!-- /.site -->
</body>
</html>
